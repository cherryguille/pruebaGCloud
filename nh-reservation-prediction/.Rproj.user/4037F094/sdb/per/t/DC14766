{
    "collab_server" : "",
    "contents" : "###############################################\n# Auditoría de variables modelo predictivo NH #      \n###############################################\n\nlibrary(\"dplyr\")\nlibrary(\"googlesheets\")\nsource(\"func_categoricas.R\")\nsource(\"func_cuantitativas.R\")\nsource(\"func_booleanas.R\")\n\n####### Autentificamos con la hoja de Drive #################\n\n# Nos identificamos en la cuenta de Drive\n\ngs_auth()\nsheet<- gs_title(\"Variables Modelo Predictivo NH\")\ntable <- data.frame(gs_read(sheet,ws = \"CustomDimension\"))\ntable <- data.frame(table[1:130,1:4])\n\n# Dividimos las variables en tres tipos:\n\ntable_cuan <- subset(table,table$Tipo == 'Cuantitativa')\ntable_cual <- subset(table,table$Tipo == 'Cualitativa')\ntable_bool <- subset(table,table$Tipo == 'Booleana')\ntable_cuan_t <- subset(table,table$Tipo == 'Cuantitativa T')\n\n## Empezamos con las variables de tipo cualitativas.\n\nfor (i in 1:NROW(table_cual)){\n  \n  variable <- paste0(\"hits.customDimensions.index=\",table_cual[i,3])\n  variable_beauty <- paste(\"Custom dimension\",table_cual[i,3],sep = \" \")\n  \n  # Asignacion de variables\n  \n  tabla_hist <- query_hist(variable)\n  variables_top <- data.frame(top_n(tabla_hist,10,cuenta))\n  tabla_evol <- query_evol(variable)\n  previews <- query_general_20(variable)\n  \n  tabla_general <- t(query_general(variable))\n  tabla_general_percent <- t(query_general_percent(variable))\n  tabla_cookie <- t(query_cookie(variable))\n  tabla_cookie_percent <- t(query_cookie_percent(variable))\n  tabla_date <- t(query_date(variable))\n  tabla_date_percent <- t(query_date_percent(variable))\n  \n  #Tabla inicial de variables\n  var_table_gen    <- rbind(tabla_general,tabla_general_percent)\n  var_table_cookie <- rbind(tabla_cookie,tabla_cookie_percent)\n  var_table_date  <- rbind(tabla_date,tabla_date_percent)\n  var_table_h <- cbind(var_table_gen,var_table_cookie,var_table_date)\n  \n  rownames(var_table_h) <- c(paste(\"Máximo\",variable_beauty,sep =\" \"),paste(\"Mínimo\",variable_beauty,sep =\" \"),paste(\"Promedio\",variable_beauty,sep =\" \"),\"Percentil 25\",\"Percentil 50\",\"Percentil 75\")\n  colnames(var_table_h) <- c(\"Valores cookie y fecha\",\"Valores por cookie\",\"Valores por fecha\")\n  kable(var_table_h, format = \"markdown\")\n  \n  #Gráfica de la evolución de la variable\n  \n  colnames(tabla_evol) <- c(\"date\",\"variable\");\n  \n  tabla_evol$dia <- as.integer(substr(tabla_evol$date,7,8));\n  tabla_evol$annomes <- as.factor(as.integer(substr(tabla_evol$date,0,6)));\n  \n  gr_evol <- ggplot(tabla_evol,aes(x = dia,y = variable)) \n  gr_evol + geom_line(colour=\"#003A70\",size=0.8) + facet_wrap(~annomes) + xlab(\"Día del mes\") + ylab(\"Frecuencia de la variable\") + ggtitle(\"Evolución de la variable en función del día\")\n  \n  ## Histograma\n  vector_top <- variables_top$cuenta\n  gr_evol_hist <- ggplot(variables_top,aes(x = cd, y = cuenta))\n  gr_evol_hist + geom_area(colour=\"#003A70\",fill=\"#003A70\",aes(x=reorder(cd,-cuenta), y=cuenta),size=5) + xlab(paste(\"Valores de\",variable_beauty,sep = \" \")) + ylab(paste(\"Número de veces\",variable_beauty,sep= \" \")) + ggtitle(paste(\"Histograma de la variable\",variable_beauty,sep= \" \")) + scale_x_discrete(labels=abbreviate)\n  \n   \n   \n  # Preview de variables\n  kable(previews, format = \"markdown\")\n  \n  input <- paste(\"entregableNH_categorica.Rmd\")\n  output <- paste0(\"htmls/Categoricas/variable_\",table_cual[i,3],\".html\")\n  rmarkdown::render(input = input, output_file = output)\n  }\n##############################################################\n\n## Seguimos con las variables cuantitativas.\n\nfor (i in 1:NROW(table_cuan)){\n            \n  variable <- paste0(\"hits.customDimensions.index=\",table_cuan[i,3])\n  variable_beauty <- paste(\"Custom dimension\",table_cuan[i,3],sep = \" \")\n            \n            # Asignacion de  variables\n  var_table_20_q <- query_general_20_q(variable)\n  tabla_evol_qsep <- query_evol_qsep(variable)\n  data_evol_sep <- data.frame(tabla_evol_qsep)\n  data_evol_sep <- data_evol_sep %>% mutate(cd_avg = mean(cd))\n  tabla_evol_qoct <- query_evol_qoct(variable)\n  data_evol_oct <- data.frame(tabla_evol_qoct)\n  data_evol_oct <- data_evol_oct %>% mutate(cd_avg = mean(cd))\n  tabla_evol_qnov <- query_evol_qnov(variable)\n  data_evol_nov <- data.frame(tabla_evol_qnov)\n  data_evol_nov <- data_evol_nov %>% mutate(cd_avg = mean(cd))\n  tabla_evol_qdic <- query_evol_qdic(variable)\n  data_evol_dic <- data.frame(tabla_evol_qdic)\n  data_evol_dic <- data_evol_dic %>% mutate(cd_avg = mean(cd))\n            \n  tabla_hist_q <- query_hist(variable)\n            \n  datos_general_q <- t(query_general_q(variable))\n  datos_general_qpercent <- t(query_general_qpercent(variable))\n  datos_cookie_q <- t(query_cookie_q(variable))\n  datos_cookie_qpercent <- t(query_cookie_qpercent(variable))\n  datos_date_q <- t(query_date_q(variable))\n  datos_date_qpercent <- t(query_date_qpercent(variable))\n            \n  var_table_general_q    <- rbind(datos_general_q,datos_general_qpercent)\n  var_table_cookie_q <- rbind(datos_cookie_q,datos_cookie_qpercent)\n  var_table_date_q  <- rbind(datos_date_q,datos_date_qpercent)\n  var_table_q <- cbind(var_table_general_q,var_table_cookie_q,var_table_date_q)\n  rownames(var_table_q) <- c(\"Máximo\", \"Mínimo\", \"Promedio\",\"Percentil 25\",\"Percentil 50\",\"Percentil 75\")\n  colnames(var_table_q) <- c(\"Valores cookie y fecha\", \"Valores por cookie\", \"Valores por fecha\")\n            \n  kable(var_table_q, format = \"markdown\")\n  kable(var_table_20_q, format = \"markdown\")\n            \n  #Gráfica de la evolución de la variable\n            \n  tabla_evol_q <- rbind(data_evol_sep,data_evol_oct,data_evol_nov,data_evol_dic)\n  colnames(tabla_evol_q) <- c(\"date\",\"cd\",\"cd_avg\");\n  tabla_evol_q$dia <- as.integer(substr(tabla_evol_q$date,7,8))\n  tabla_evol_q$annomes <- as.factor(as.integer(substr(tabla_evol_q$date,0,6)))\n            \n            \n  gr_evol <- ggplot(tabla_evol_q,aes(x = dia, y = cd))\n  gr_evol + geom_hline(data=tabla_evol_q, aes(yintercept=cd_avg), colour=\"red\",size=0.4) +  facet_wrap(~annomes) + geom_line(colour=\"#003A70\",size=0.8) + facet_wrap(~annomes) + xlab(\"Día del mes\") + ylab(variable_beauty) + ggtitle(paste(\"Evolución de\",variable_beauty,\"en función del mes\",sep=\" \"))\n            \n  ## Histograma\n            \n  gr_evol_hist <- ggplot(tabla_hist_q,aes(x = cd))\n  gr_evol_hist + geom_area(colour=\"#003A70\",fill=\"#003A70\",aes(x=reorder(cd,-cuenta), y=cuenta),size=5) + xlab(paste(\"Valores de\",variable_beauty,sep = \" \")) + ylab(paste(\"Número de veces\",variable_beauty,sep= \" \")) + ggtitle(paste(\"Histograma de la variable\",variable_beauty,sep= \" \")) + scale_x_discrete(labels=abbreviate)\n            \n  input <- paste(\"entregableNH_cuanti.Rmd\")\n  output <- paste0(\"htmls/Cuantitativas/variable_\",table_cuan[i,3],\".html\")\n  rmarkdown::render(input = input, output_file = output)\n}\n\n##############################################################\n\n## Seguimos con las variables booleanas.\n\nfor (i in 1:NROW(table_cuan)){\n  \n  variable <- paste0(\"hits.customDimensions.index=\",table_bool[i,3])\n  variable_beauty <- paste(\"Custom dimension\",table_bool[i,3],sep = \" \")\n  \n# Asignamos variables.\n\nevol_b <- query_evolb(cd)\ntabla_generalb <- query_generalb(cd)\ntabla_previewb <- query_general_20b(cd)\nevol_b_total <- query_generalb_total(cd)\n\n#evol_b_total <- data.frame(5622447,2469400)\n#colnames(evol_b_total) <- c(\"New Cookie\", \"Returning Cookie\")\ncolnames(tabla_generalb) <- c(\"Tipo de cookie\", \"Máximo\", \"Mínimo\", \"Promedio\")\ntabla_generalb <- data.frame(tabla_generalb)\nkable(tabla_generalb, format = \"markdown\")\ncolnames(tabla_previewb) <- c(\"fecha\", \"Cookie_id\",\"Frecuencia de la cd\")\ntabla_previewb <- data.frame(tabla_previewb)\nkable(tabla_previewb, format = \"markdown\")\ncolnames(evol_b_total) <- c(\"Valor de variable\",\"Veces que se repite\")\nkable(evol_b_total)\n\n#Evolucion\ncolnames(evol_b) <- c(\"date\",\"b_cookie_state\",\"count_cookie\");\n\nevol_b$dia <- as.integer(substr(evol_b$date,7,8));\nevol_b$annomes <- as.factor(as.integer(substr(evol_b$date,0,6)))\n\nevol_b_final <- data.frame(evol_b)\ngr_evol <- ggplot(evol_b_final,aes(x = dia,y = count_cookie))\ngr_evol +  geom_line(aes(group = b_cookie_state)) + facet_wrap(~annomes) + xlab(\"Día del mes\") + ylab(\"Número de cookies\") + ggtitle(\"Evolución tipo de cd booleano\")\n\ninput <- paste(\"entregableNH_bool.Rmd\")\noutput <- paste0(\"htmls/Booleanas/variable_\",table_bool[i,3],\".html\")\nrmarkdown::render(input = input, output_file = output)\n}",
    "created" : 1486035665188.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "354538103",
    "id" : "DC14766",
    "lastKnownWriteTime" : 1486463430,
    "last_content_update" : 1486463430931,
    "path" : "C:/Clientes/NH/Proyecto Modelo predictivo/Entregable HTML/master.R",
    "project_path" : "master.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}