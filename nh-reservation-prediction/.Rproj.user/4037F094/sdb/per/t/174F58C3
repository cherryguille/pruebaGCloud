{
    "collab_server" : "",
    "contents" : "library(bigrquery)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(knitr)\n\n######### FUNCION FECHA ###########\nfecha <- function(input_date){\n  year <- substr(input_date,1,4);\n  month <- substr(input_date,5,6);\n  day <- substr(input_date,7,8);\n  out_date <- paste(year,month,day,sep = \"-\")\n  return(out_date)}\n\n\n######### CONEXION BIGQUERY ###########\n# BigQuery project Id - NH\nBQ_PROJECT_ID <- \"useful-art-91609\";\n#BigQuery NH DataSet for Google Analytics Premium\n#BQ_DATASET_ID <- NH_pred;\n\n#Queries para las variables genericas\ny\n\nquery_var_gen <- function(){\n  cat(file=stderr(), \"Como mola la gramola\");\n  query <- paste(\"\n                 SELECT \n                    round(MAX(pageviews),2) as maxPV,\n                    round(MIN(pageviews),2) as minPV,\n                    round(AVG(pageviews),2) as avgPV,\n                 FROM [useful-art-91609:NH_pred.Ventanas_temporales] \n                 \")\n  data <- query_exec( query=query, project = BQ_PROJECT_ID )\n  data\n}\nquery_perc_gen <- function(){\n  query <- paste(\"\n                5\n                 \")\n  data <- query_exec( query=query, project = BQ_PROJECT_ID )\n  data\n}\n\n#Queries para las variables de tipo cookie\nquery_var_cookie <- function(){\n  cat(file=stderr(), \"Como mola la gramola\");\n  query <- paste(\"\n                 SELECT\n                 round(MAX(sumPV),2) as maxPV,\n                 round(MIN(sumPV),2) as minPV,\n                 round(AVG(sumPV),2) as avgPV,\n                 FROM(\n                 SELECT \n                 cookie_id,\n                 SUM(pageviews) as sumPV\n                 FROM [useful-art-91609:NH_pred.Ventanas_temporales]\n                 group by 1)\n                 \")\n  data <- query_exec( query=query, project = BQ_PROJECT_ID )\n  data\n}\nquery_perc_cookie <- function(){\n  query <- paste(\"\n                 SELECT\n                 p_cont25,\n                 p_cont50,\n                 p_cont75\n                 FROM(\n                 SELECT \n                 PERCENTILE_CONT(0.25) OVER (PARTITION BY var_aux ORDER BY sumPV ASC) as p_cont25,\n                 PERCENTILE_CONT(0.5) OVER (PARTITION BY var_aux ORDER BY sumPV ASC) as p_cont50,\n                 PERCENTILE_CONT(0.75) OVER (PARTITION BY var_aux ORDER BY sumPV ASC) as p_cont75,\n                 FROM (\n                 SELECT \n                 //date,\n                 if(cookie_id is not null,1,0) as var_aux,\n                 cookie_id,\n                 SUM(pageviews) as sumPV \n                 FROM [useful-art-91609:NH_pred.Ventanas_temporales] \n                 group by 1,2))\n                 where p_cont25 is not null\n                 and p_cont50 is not null\n                 and p_cont75 is not null\n                 GROUP BY 1,2,3\n                 \")\n  data <- query_exec( query=query, project = BQ_PROJECT_ID )\n  data\n}\n\n#Queries para las variables de tipo cookie y fecha\nquery_var_fecha <- function(){\n  cat(file=stderr(), \"Como mola la gramola\");\n  query <- paste(\"\n                 SELECT\n                 round(MAX(sumPV),2) as maxPV,\n                 round(MIN(sumPV),2) as minPV,\n                 round(AVG(sumPV),2) as avgPV,\n                 FROM(\n                 SELECT \n                 date,\n                 SUM(pageviews) as sumPV\n                 FROM [useful-art-91609:NH_pred.Ventanas_temporales]\n                 group by 1)\n                 \")\n  data <- query_exec( query=query, project = BQ_PROJECT_ID )\n  data\n}\nquery_perc_fecha <- function(){\n  query <- paste(\"\n                 SELECT\np_cont25,\n                 p_cont50,\n                 p_cont75\n                 FROM(\n                 SELECT \n                 PERCENTILE_CONT(0.25) OVER (PARTITION BY var_aux ORDER BY sumPV ASC) as p_cont25,\n                 PERCENTILE_CONT(0.5) OVER (PARTITION BY var_aux ORDER BY sumPV ASC) as p_cont50,\n                 PERCENTILE_CONT(0.75) OVER (PARTITION BY var_aux ORDER BY sumPV ASC) as p_cont75,\n                 FROM (\n                 SELECT \n                 date,\n                 if(cookie_id is not null,1,0) as var_aux,\n                 //cookie_id,\n                 SUM(pageviews) as sumPV \n                 FROM [useful-art-91609:NH_pred.Ventanas_temporales] \n                 group by 1,2))\n                 where p_cont25 is not null\n                 and p_cont50 is not null\n                 and p_cont75 is not null\n                 GROUP BY 1,2,3\n                 \")\n  data <- query_exec( query=query, project = BQ_PROJECT_ID )\n  data\n}\n\n\n#Asociar query a valores\nvar_table_20 <- query_var_gen_20()\ndatos_gen <- t(query_var_gen())\nperc_gen <- t(query_perc_gen())\ndatos_cookie <- t(query_var_cookie())\nperc_cookie <- t(query_perc_cookie())\ndatos_fecha <- t(query_var_fecha())\nperc_fecha <- t(query_perc_fecha())\nfiles_hardoce <- t(data.frame(0,0))\n\n#Variable que sacaremos por pantalla\nvar_table_gen    <- rbind(datos_gen,perc_gen,files_hardoce)\nvar_table_cookie <- rbind(datos_cookie,perc_cookie,files_hardoce)\nvar_table_fecha  <- rbind(datos_fecha,perc_fecha,files_hardoce)\nvar_table <- cbind(var_table_gen,var_table_cookie,var_table_fecha)\nrownames(var_table) <- c(\"Máximo\", \"Mínimo\", \"Promedio\",\"Percentil 25\",\"Percentil 50\",\"Percentil 75\", \"Número de nulls\",\"Porcentaje de nulls sobre el total\")\ncolnames(var_table) <- c(\"Valores cookie y fecha\", \"Valores por cookie\", \"Valores por fecha\")\nkable(var_table, format = \"markdown\")\nkable(var_table_20, format = \"markdown\")\n\n#Graficas\nquery_sep <- \"SELECT date,sum(pageviews) as page_v FROM(SELECT date,SUBSTR(date,5,2) as mes,cookie_id,pageviews FROM [useful-art-91609:NH_pred.Ventanas_temporales]) WHERE date IS NOT NULL and mes = '09' GROUP BY 1 ORDER BY 1 ASC\"\nquery_oct <- \"SELECT date,sum(pageviews) as page_v FROM(SELECT date,SUBSTR(date,5,2) as mes,cookie_id,pageviews FROM [useful-art-91609:NH_pred.Ventanas_temporales]) WHERE date IS NOT NULL and mes = '10' GROUP BY 1 ORDER BY 1 ASC\"\nquery_nov <- \"SELECT date,sum(pageviews) as page_v FROM(SELECT date,SUBSTR(date,5,2) as mes,cookie_id,pageviews FROM [useful-art-91609:NH_pred.Ventanas_temporales]) WHERE date IS NOT NULL and mes = '11' GROUP BY 1 ORDER BY 1 ASC\"\nquery_dic <- \"SELECT date,sum(pageviews) as page_v FROM(SELECT date,SUBSTR(date,5,2) as mes,cookie_id,pageviews FROM [useful-art-91609:NH_pred.Ventanas_temporales]) WHERE date IS NOT NULL and mes = '12' GROUP BY 1 ORDER BY 1 ASC\"\n\ndata_features_sep <- query_exec(query = query_sep,project = BQ_PROJECT_ID,max_pages = Inf);\ndata_features_sep <- data.frame(data_features_sep);\ndata_features_sep <- data_features_sep %>% mutate(page_v_avg = mean(page_v))\ncolnames(data_features_sep) <- c(\"date\",\"page_v\",\"page_v_avg\");\ndata_features_oct <- query_exec(query = query_oct,project = BQ_PROJECT_ID,max_pages = Inf);\ndata_features_oct <- data.frame(data_features_oct);\ndata_features_oct <- data_features_oct %>% mutate(page_v_avg = mean(page_v))\ncolnames(data_features_oct) <- c(\"date\",\"page_v\",\"page_v_avg\");\ndata_features_nov <- query_exec(query = query_nov,project = BQ_PROJECT_ID,max_pages = Inf);\ndata_features_nov <- data.frame(data_features_nov);\ndata_features_nov <- data_features_nov %>% mutate(page_v_avg = mean(page_v))\ncolnames(data_features_nov) <- c(\"date\",\"page_v\",\"page_v_avg\");\ndata_features_dic <- query_exec(query = query_dic,project = BQ_PROJECT_ID,max_pages = Inf);\ndata_features_dic <- data.frame(data_features_dic);\ndata_features_dic <- data_features_dic %>% mutate(page_v_avg = mean(page_v))\ncolnames(data_features_dic) <- c(\"date\",\"page_v\",\"page_v_avg\");\n\n#############################################################################\n\n# Grafico evolutivo de la variable cuantitativa.\n#evol_pv <- rbind(data_features_sep_avg,data_features_oct_avg,data_features_nov_avg,data_features_dic_avg)\nevol_pv <- rbind(data_features_sep,data_features_oct,data_features_nov,data_features_dic)\ncolnames(evol_pv) <- c(\"date\",\"page_v\",\"page_v_avg\");\nevol_pv$dia <- as.integer(substr(evol_pv$date,7,8))\nevol_pv$annomes <- as.factor(as.integer(substr(evol_pv$date,0,6)))\ngr_evol <- ggplot(evol_pv,aes(x = dia, y = page_v))\ngr_evol + geom_hline(yintercept = evol_pv$page_v_avg, colour=\"red\",size=0.4) +  facet_wrap(~annomes) + geom_line(colour=\"#003A70\",size=0.8) + facet_wrap(~annomes) + xlab(\"Día del mes\") + ylab(\"Páginas vistas\") + ggtitle(\"Evolución de Páginas vistas en función del mes\")\n\n\n#Histograma\nquery_cookie <- \"SELECT count(cookie_id) as count_id, pv\n                  FROM(\n                  SELECT cookie_id, sum(pageviews) as pv\n                  FROM [useful-art-91609:NH_pred.Ventanas_temporales] group by 1)\n                  where pv is not null\n                  group by 2\n                  order by 2 asc\"\ndata_features_cookie <- query_exec(query = query_cookie,project = BQ_PROJECT_ID,max_pages = Inf)\ndata_features_cookie_10 <- head(data_features_cookie,10)\ngr_evol_hist <- ggplot(data_features_cookie_10,aes(x = pv))\ngr_evol_hist + geom_area(colour=\"#003A70\",fill=\"#003A70\",aes(y=count_id)) + xlab(\"Páginas vistas\") + ylab(\"Número de cookies\") + ggtitle(\"Histograma\") + scale_x_continuous(breaks = 1:10)\n\n\n\n",
    "created" : 1486369328204.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1283570056",
    "id" : "174F58C3",
    "lastKnownWriteTime" : 1486398499,
    "last_content_update" : 1486398499846,
    "path" : "C:/Clientes/NH/Proyecto Modelo predictivo/Entregable HTML/NH_cuanti.r",
    "project_path" : "NH_cuanti.r",
    "properties" : {
        "source_window_id" : "wloje74pef9mb"
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}