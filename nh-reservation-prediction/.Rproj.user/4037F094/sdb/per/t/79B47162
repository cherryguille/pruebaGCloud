{
    "collab_server" : "",
    "contents" : "\n#### Funcion de computo de las variables categorícas ####\n\nlibrary(bigrquery)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(knitr)\n\n######### FUNCION FECHA ###########\n\nfecha <- function(input_date){\n  year <- substr(input_date,1,4);\n  month <- substr(input_date,5,6);\n  day <- substr(input_date,7,8);\n  out_date <- paste(year,month,day,sep = \"-\")\n  return(out_date)}\n\n\n######### CONEXION BIGQUERY ###########\n# BigQuery project Id - NH\n\nBQ_PROJECT_ID <- \"useful-art-91609\"\n\n#BigQuery NH DataSet for Google Analytics Premium\n\nBQ_DATASET_ID <- \"NH_pred\";\n\n### Extracción de los datos para el html de las variables categoricas ###\n\nquery_evol <- function(cd){\n  \n  query <- paste(\"SELECT \n                 date,\n                 count(cd)\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 max(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1\",sep=\"\")\n\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_hist <- function(cd){\n  \n  query <- paste(\"SELECT \n                 cd,\n                 Count(cd) as cuenta\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 max(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1\n                 order by cuenta desc\n                 limit 10\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\n\nquery_general <- function(cd){\n  \n  query <- paste(\"\n                 SELECT\n                 ROUND(MAX(frecuencia),2) as max,\n                 ROUND(MIN(frecuencia),2) as min,\n                 ROUND(AVG(frecuencia),2) as avg,\n                 FROM(                 \n                 SELECT\n                 date,\n                 cookie_id,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 Count(cd) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 max(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1,2)\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_general_percent <- function(cd){\n  query <- paste(\"\n                 SELECT \n                 p_cont25,\n                 p_cont50,\n                 p_cont75\n                 FROM(\n                 SELECT \n                 PERCENTILE_CONT(0.01) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont25,\n                 PERCENTILE_CONT(0.5) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont50,\n                 PERCENTILE_CONT(0.75) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont75,\n                 FROM(\n                 SELECT\n                 date,\n                 cookie_id,\n                 1 as var_aux,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 Count(cd) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 MAX(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1,2,3))\n                 GROUP BY 1,2,3\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_cookie <- function(cd){\n  query <- paste(\"\n                 SELECT\n                 ROUND(MAX(frecuencia),2) as max,\n                 ROUND(MIN(frecuencia),2) as min,\n                 ROUND(AVG(frecuencia),2) as avg,\n                 FROM(                 \n                 SELECT\n                 cookie_id,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 Count(cd) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 MAX(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1)\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_cookie_percent <- function(cd){\n  \nquery <- paste(\"\n                 SELECT \n                 p_cont25,\n                 p_cont50,\n                 p_cont75\n                 FROM(\n                 SELECT \n                 PERCENTILE_CONT(0.01) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont25,\n                 PERCENTILE_CONT(0.5) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont50,\n                 PERCENTILE_CONT(0.75) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont75,\n                 FROM(\n                 SELECT\n                 cookie_id,\n                 1 as var_aux,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 Count(cd) as frecuencia\n                 FROM( \n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 MAX(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1,2\n                 ))\n                 GROUP BY 1,2,3\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_date <- function(cd){\n  \n  query <- paste(\"\n                 SELECT\n                 ROUND(MAX(frecuencia),2) as max,\n                 ROUND(MIN(frecuencia),2) as min,\n                 ROUND(AVG(frecuencia),2) as avg,\n                 FROM(                 \n                 SELECT\n                 date,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 Count(cd) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 MAX(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1)\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_date_percent <- function(cd){\n  \nquery <- paste(\"\n                 SELECT \n                 p_cont25,\n                 p_cont50,\n                 p_cont75\n                 FROM(\n                 SELECT \n                 PERCENTILE_CONT(0.01) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont25,\n                 PERCENTILE_CONT(0.5) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont50,\n                 PERCENTILE_CONT(0.75) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont75,\n                 FROM(\n                 SELECT\n                 date,\n                 1 as var_aux,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 Count(cd) as frecuencia\n                 FROM(\n                 SELECT \n                  date,\n                  fullVisitorId as cookie_id,\n                  MAX(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                  FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1,2\n                 ))\n                 GROUP BY 1,2,3\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\n\nquery_general_20 <- function(cd){\n  query <- paste(\"\n                 SELECT\n                 date,\n                 cookie_id,\n                 cd,\n                 Count(cd) as frecuencia\n                 FROM (\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 MAX(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3\n                 order by frecuencia desc, cookie_id desc, date asc\n                 limit 20\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\n\n### Fin del programa de las queries ###",
    "created" : 1486383987574.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "29|27|44|0|\n45|27|62|0|\n64|30|93|0|\n94|38|129|0|\n130|29|157|0|\n158|37|194|0|\n195|27|223|0|\n224|35|260|0|\n262|33|281|0|\n",
    "hash" : "29812315",
    "id" : "79B47162",
    "lastKnownWriteTime" : 1486371775,
    "last_content_update" : 1486455419964,
    "path" : "C:/Clientes/NH/Proyecto Modelo predictivo/Entregable HTML/func_categoricas.R",
    "project_path" : "func_categoricas.R",
    "properties" : {
        "source_window_id" : ""
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}