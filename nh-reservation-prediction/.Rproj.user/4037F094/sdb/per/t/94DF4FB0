{
    "collab_server" : "",
    "contents" : "\n#### Funcion de computo de las variables categorícas ####\n\nlibrary(bigrquery)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(knitr)\n\n######### FUNCION FECHA ###########\n\nfecha <- function(input_date){\n  year <- substr(input_date,1,4);\n  month <- substr(input_date,5,6);\n  day <- substr(input_date,7,8);\n  out_date <- paste(year,month,day,sep = \"-\")\n  return(out_date)}\n\n\n######### CONEXION BIGQUERY ###########\n# BigQuery project Id - NH\n\nBQ_PROJECT_ID <- \"useful-art-91609\"\n\n#BigQuery NH DataSet for Google Analytics Premium\n\nBQ_DATASET_ID <- \"NH_pred\";\n\n### Extracción de los datos para el html de las variables cualitativas ###\n\nquery_evol_qsep <- function(cd){\n  \n  query <- paste(\"\n                  SELECT\n                 date,\n                 sum(INTEGER(cd)) as cd \n                 FROM(\n                 SELECT\n                 date,\n                 SUBSTR(date,5,2) as mes,\n                 cookie_id,\n                 cd\n                 FROM(\n                 SELECT\n                 date,\n                 fullVisitorId as cookie_id,\n                 max(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN record AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 )\n                 WHERE date IS NOT NULL and mes = '09'\n                 GROUP BY 1\n                \")\n  \n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_evol_qoct <- function(cd){\n  \n  query <- paste(\"\n                  SELECT\n                 date,\n                 sum(INTEGER(cd)) as cd \n                 FROM(\n                 SELECT\n                 date,\n                 SUBSTR(date,5,2) as mes,\n                 cookie_id,\n                 cd\n                 FROM(\n                 SELECT\n                 date,\n                 fullVisitorId as cookie_id,\n                 max(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 )\n                 WHERE date IS NOT NULL and mes = '10'\n                 GROUP BY 1\n                \")\n  \n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_evol_qnov <- function(cd){\n  \n  query <- paste(\"\n                 SELECT\n                 date,\n                 sum(INTEGER(cd)) as cd \n                 FROM(\n                 SELECT\n                 date,\n                 SUBSTR(date,5,2) as mes,\n                 cookie_id,\n                 cd\n                 FROM(\n                 SELECT\n                 date,\n                 fullVisitorId as cookie_id,\n                 max(IF(\",cd,\",hits.customDimensions.index = 35,hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 )\n                 WHERE date IS NOT NULL and mes = '11'\n                 GROUP BY 1\n                 \")\n  \n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_evol_qdic <- function(cd){\n  \n  query <- paste(\"\n                 SELECT\n                 date,\n                 sum(INTEGER(cd)) as cd \n                 FROM(\n                 SELECT\n                 date,\n                 SUBSTR(date,5,2) as mes,\n                 cookie_id,\n                 cd\n                 FROM(\n                 SELECT\n                 date,\n                 fullVisitorId as cookie_id,\n                 max(IF(\",cd,\",hits.customDimensions.index = 35,hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 )\n                 WHERE date IS NOT NULL and mes = '12'\n                 GROUP BY 1\n                 \")\n  \n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\n\nquery_hist_q <- function(cd){\n  \n  query <- paste(\"SELECT \n                 cd,\n                 count(cookie_id) as cuenta\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 max(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN record AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1\n                 order by cuenta desc\n                 limit 10\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\n\nquery_general_q <- function(cd){\n  \n  query <- paste(\"\n                 SELECT\n                 ROUND(MAX(frecuencia),2) as max,\n                 ROUND(MIN(frecuencia),2) as min,\n                 ROUND(AVG(frecuencia),2) as avg,\n                 FROM(                 \n                 SELECT\n                 date,\n                 cookie_id,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 Count(integer(cd)) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 max(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN record AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20160922')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1,2)\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_general_qpercent <- function(cd){\n  query <- paste(\"\n                 SELECT \n                 p_cont25,\n                 p_cont50,\n                 p_cont75\n                 FROM(\n                 SELECT \n                 PERCENTILE_CONT(0.01) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont25,\n                 PERCENTILE_CONT(0.5) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont50,\n                 PERCENTILE_CONT(0.75) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont75,\n                 FROM(\n                 SELECT\n                 date,\n                 cookie_id,\n                 1 as var_aux,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 Count(cd) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 MAX(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN record AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1,2,3))\n                 GROUP BY 1,2,3\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\n\nquery_cookie_q <- function(cd){\n  query <- paste(\"\n                 SELECT\n                 ROUND(MAX(frecuencia),2) as max,\n                 ROUND(MIN(frecuencia),2) as min,\n                 ROUND(AVG(frecuencia),2) as avg,\n                 FROM(                 \n                 SELECT\n                 cookie_id,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 Count(integer(cd)) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 max(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN record AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20160922')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1)\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_cookie_qpercent <- function(cd){\n  \n  query <- paste(\"\n                 SELECT \n                 p_cont25,\n                 p_cont50,\n                 p_cont75\n                 FROM(\n                 SELECT \n                 PERCENTILE_CONT(0.01) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont25,\n                 PERCENTILE_CONT(0.5) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont50,\n                 PERCENTILE_CONT(0.75) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont75,\n                 FROM(\n                 SELECT\n                 date,\n                 1 as var_aux,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 count(integer(cd)) as frecuencia\n                 FROM( \n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 MAX(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN record AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1,2\n                 ))\n                 GROUP BY 1,2,3\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\n\nquery_date_q <- function(cd){\n  \n  query <- paste(\"\n                 SELECT\n                 ROUND(MAX(frecuencia),2) as max,\n                 ROUND(MIN(frecuencia),2) as min,\n                 ROUND(AVG(frecuencia),2) as avg,\n                 FROM(                 \n                 SELECT\n                 date,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 Count(integer(cd)) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 MAX(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN record AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1)\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\nquery_date_qpercent <- function(cd){\n  \n  query <- paste(\"\n                 SELECT \n                 p_cont25,\n                 p_cont50,\n                 p_cont75\n                 FROM(\n                 SELECT \n                 PERCENTILE_CONT(0.01) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont25,\n                 PERCENTILE_CONT(0.5) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont50,\n                 PERCENTILE_CONT(0.75) OVER (PARTITION BY var_aux ORDER BY frecuencia ASC) as p_cont75,\n                 FROM(\n                 SELECT\n                 date,\n                 1 as var_aux,\n                 SUM(frecuencia) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 cookie_id,\n                 cd,\n                 Count(cd) as frecuencia\n                 FROM(\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 MAX(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN record AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3)\n                 GROUP BY 1,2\n                 ))\n                 GROUP BY 1,2,3\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\n\nquery_general_20_q <- function(cd){\n  query <- paste(\"\n                 SELECT\n                 date,\n                 cookie_id,\n                 cd,\n                 FROM (\n                 SELECT \n                 date,\n                 fullVisitorId as cookie_id,\n                 MAX(IF(\",cd,\",hits.customDimensions.value,NULL)) WITHIN hits AS cd\n                 FROM TABLE_DATE_RANGE([94438972.ga_sessions_],TIMESTAMP('20160922'),TIMESTAMP('20161222')))\n                 GROUP BY 1,2,3\n                 order by cd desc, cookie_id desc, date asc\n                 limit 20\n                 \")\n  data <- query_exec(query=query, project = BQ_PROJECT_ID,max_pages = Inf)\n  data\n}\n\n\n### Fin del programa de las queries ###",
    "created" : 1486371764993.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "29|32|54|0|\n55|32|80|0|\n81|32|106|0|\n107|32|132|0|\n134|29|151|0|\n153|32|182|0|\n183|39|218|0|\n220|31|247|0|\n248|38|284|0|\n286|29|314|0|\n315|36|351|0|\n353|35|371|0|\n",
    "hash" : "952388084",
    "id" : "94DF4FB0",
    "lastKnownWriteTime" : 1486383711,
    "last_content_update" : 1486384017928,
    "path" : "C:/Clientes/NH/Proyecto Modelo predictivo/Entregable HTML/func_cuantitativas.R",
    "project_path" : "func_cuantitativas.R",
    "properties" : {
        "tempName" : "Untitled2"
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}